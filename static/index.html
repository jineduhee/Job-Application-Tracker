<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Job Application Tracker</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <div class="container">
      <h1>Job Applications</h1>
      <ul id="job-list"></ul>

      <h2>Add New Application</h2>
      <form id="job-form">
        <input type="text" id="company" placeholder="Company" required /><br />
        <input type="text" id="position" placeholder="Position" required /><br />
        <select id="status" required>
          <option value="">Select Status</option>
          <option value="Applied">Applied</option>
          <option value="Interview">Interview</option>
          <option value="Phone Screen">Phone Screen</option>
          <option value="Technical Interview">Technical Interview</option>
          <option value="Final Round">Final Round</option>
          <option value="Offer">Offer</option>
          <option value="Rejected">Rejected</option>
          <option value="Withdrawn">Withdrawn</option>
          <option value="Accepted">Accepted</option>
        </select><br />
        <input type="text" id="notes" placeholder="Notes" /><br />
        <button type="submit">Add Application</button>
        <button type="button" id="cancel-edit" style="display: none">
          Cancel Edit
        </button>
      </form>
    </div>

    <script>
      // Get DOM elements
      const jobList = document.getElementById("job-list");
      const form = document.getElementById("job-form");
      const cancelBtn = document.getElementById("cancel-edit");
      let editingId = null;

      // Show notification toast
      function showToast(message, duration = 3000) {
        const toast = document.getElementById("toast");
        const sound = document.getElementById("notif-sound");

        toast.textContent = message;
        toast.classList.add("show");

        // Play notification sound
        if (sound) {
          sound.currentTime = 0;
          sound.play().catch((e) => {
            console.log("Sound play failed:", e);
          });
        }

        // Mobile vibration
        if (navigator.vibrate) {
          navigator.vibrate([100, 50, 100]);
        }

        setTimeout(() => {
          toast.classList.remove("show");
        }, duration);
      }

      // Load and display all job applications
      async function loadJobs() {
        jobList.innerHTML = '<div class="loading"></div>';
        
        const res = await fetch("/applications/");
        const jobs = await res.json();
        jobList.innerHTML = "";
        
        jobs.forEach((job, index) => {
          const li = document.createElement("li");
          li.innerHTML = `
            <div class="job-info">
              <strong>${job.position}</strong> at <strong>${job.company}</strong> ‚Äì <span class="status">${job.status}</span>
              ${job.notes ? `<div class="notes">üìù ${job.notes}</div>` : ''}
            </div>
            <div class="job-actions">
              <button onclick="editJob(${job.id}, '${job.company}', '${
                job.position
              }', '${job.status}', \`${job.notes || ""}\`)">‚úèÔ∏è Edit</button>
              <button onclick="deleteJob(${job.id})">‚ùå Delete</button>
            </div>
          `;
          
          // Stagger animation timing
          li.style.animationDelay = `${index * 0.1}s`;
          jobList.appendChild(li);
        });
      }

      // Cancel edit mode
      cancelBtn.addEventListener("click", () => {
        editingId = null;
        form.reset();
        cancelBtn.style.display = "none";
        showToast("Edit cancelled");
      });

      // Enter edit mode for a job
      function editJob(id, company, position, status, notes) {
        editingId = id;
        document.getElementById("company").value = company;
        document.getElementById("position").value = position;
        document.getElementById("status").value = status;
        document.getElementById("notes").value = notes;
        cancelBtn.style.display = "inline-block";
        
        // Animate form
        form.style.animation = "pulse 0.6s ease-out";
        setTimeout(() => {
          form.style.animation = "";
        }, 600);
      }

      // Delete a job application
      async function deleteJob(id) {
        if (!confirm("Delete this application?")) return;
        
        const jobElement = document.querySelector(`button[onclick="deleteJob(${id})"]`).closest('li');
        jobElement.style.animation = "slideOutLeft 0.3s ease-out forwards";
        
        await fetch(`/applications/${id}`, { method: "DELETE" });
        showToast("Application deleted!");
        
        setTimeout(() => {
          loadJobs();
        }, 300);
      }

      // Handle form submission
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        
        // Button press animation
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.style.transform = "scale(0.95)";
        setTimeout(() => {
          submitBtn.style.transform = "";
        }, 150);
        
        const jobData = {
          company: document.getElementById("company").value,
          position: document.getElementById("position").value,
          status: document.getElementById("status").value,
          notes: document.getElementById("notes").value,
        };

        if (editingId) {
          await fetch(`/applications/${editingId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(jobData),
          });
          showToast("Application updated!");
          editingId = null;
        } else {
          await fetch("/applications/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(jobData),
          });
          showToast("Application added!");
        }

        form.reset();
        cancelBtn.style.display = "none";
        loadJobs();
      });

      // Load jobs on page load
      loadJobs();
    </script>
    <div id="toast" class="toast"></div>
    <audio id="notif-sound" src="/static/ding.mp3" preload="auto"></audio>
  </body>
</html>
